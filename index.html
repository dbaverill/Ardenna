<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>s/v Ardenna Log</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; background: #f4f4f9; }
        
        /* Navigation */
        nav { background: #2c3e50; padding: 0 10px; display: flex; align-items: center; height: 50px; flex-shrink: 0; justify-content: space-between; }
        .nav-left { display: flex; align-items: center; overflow-x: auto; }
        nav h1 { color: white; margin: 0 15px 0 0; font-size: 1.1rem; font-style: italic; white-space: nowrap; }
        .tab { color: #aaa; padding: 15px 15px; cursor: pointer; text-transform: uppercase; font-size: 0.8rem; font-weight: bold; letter-spacing: 1px; white-space: nowrap; }
        .tab:hover { color: white; }
        .tab.active { color: white; border-bottom: 3px solid #3498db; background: rgba(255,255,255,0.05); }
        
        /* Admin Lock */
        .admin-lock { cursor: pointer; opacity: 0.3; font-size: 1.2rem; margin-left: 10px; }
        .admin-lock:hover { opacity: 1; }
        .admin-active { opacity: 1; filter: drop-shadow(0 0 5px #00ff00); }

        /* Main Views */
        .view-container { display: none; height: calc(100vh - 50px); width: 100%; }
        .view-container.active { display: flex; }
        
        /* Sidebar & Map */
        #sidebar { width: 400px; display: flex; flex-direction: column; background: #f8f9fa; border-right: 1px solid #ddd; z-index: 2; overflow: hidden; }
        #map { flex-grow: 1; height: 100%; z-index: 1; position: relative; }
        .map-reset-btn { position: absolute; top: 10px; right: 10px; z-index: 1000; background: white; padding: 8px 12px; border-radius: 4px; border: 2px solid rgba(0,0,0,0.2); cursor: pointer; font-weight: bold; font-size: 0.9em; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        /* Common Elements */
        .sidebar-header { padding: 20px; background: white; border-bottom: 1px solid #eee; display: none; }
        button.primary { background: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; width: 100%; font-size: 1rem; }
        input, textarea, select { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        /* FILTER BAR */
        .filter-bar { padding: 10px 15px; background: #fff; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
        .filter-select { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; background: #f9f9f9; font-size: 0.9rem; margin: 0; }

        /* Log Entries */
        #entries-container { flex-grow: 1; overflow-y: auto; padding: 0; }
        .month-header { 
            padding: 12px 15px; 
            background: #e9ecef; 
            font-weight: bold; 
            border-bottom: 1px solid #ddd; 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            color: #2c3e50;
            user-select: none;
        }
        .month-header:hover { background: #dee2e6; }
        .month-header .toggle-icon { font-size: 0.8em; color: #666; }
        
        .log-entry { background: white; padding: 15px; border-radius: 8px; margin: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; border: 1px solid #eee; position: relative; transition: border-color 0.2s; }
        .log-entry:hover { border-color: #3498db; }
        .log-entry.active-trip { border-left: 5px solid #3498db; background: #fafdff; }
        .log-img { width: 100%; height: auto; border-radius: 4px; margin-top: 10px; background: #eee; display: block; }
        .log-stats { font-size: 0.85em; color: #555; background: #f1f3f5; padding: 5px 10px; border-radius: 4px; display: inline-block; margin-top: 5px; font-weight: 500; }
        #entry-form { display: none; padding: 15px; background: #eef2f5; border-bottom: 1px solid #ddd; }
        
        /* Buttons */
        .action-btn { position: absolute; top: 10px; cursor: pointer; font-size: 1.2rem; line-height: 1; padding: 5px; z-index: 10; display: none; font-weight: bold; }
        .delete-btn { right: 10px; color: #ff4444; }
        .edit-btn { right: 40px; color: #aaa; }

        /* General Layouts */
        .scroll-container { flex-direction: column; overflow-y: auto; padding: 40px; box-sizing: border-box; max-width: 1200px; margin: 0 auto; width: 100%; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #eee; display: flex; flex-direction: column; margin-bottom: 20px; }
        .card h2 { margin-top: 0; font-size: 1.2rem; color: #2c3e50; border-bottom: 2px solid #f1f1f1; padding-bottom: 10px; }
        
        .manifest-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 40px; }
        
        /* -------------------------------------- */
        /* QUILL EDITOR STYLES (Smart Toggle)     */
        /* -------------------------------------- */
        /* Default (Visitor Mode): Clean text, no chrome */
        .ql-toolbar { display: none; }
        .ql-container.ql-snow { border: none; }
        .ql-container { font-family: -apple-system, system-ui, sans-serif; font-size: 1rem; height: auto; }
        .ql-editor { padding: 0; overflow-y: visible; }
        /* Magazine Image Styling */
        .ql-editor img { max-width: 100%; height: auto; border-radius: 4px; margin: 10px 0; display: block; }

        /* Admin Mode (When body has .is-admin class) */
        body.is-admin .ql-toolbar { display: block; border-radius: 4px 4px 0 0; }
        body.is-admin .ql-container.ql-snow { border: 1px solid #ccc; border-radius: 0 0 4px 4px; }
        body.is-admin .ql-container { background: #fafafa; height: 350px; /* Taller for Crew page */ }
        body.is-admin .ql-editor { padding: 12px 15px; overflow-y: auto; }

        /* Maintenance Table */
        .maint-section { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        th { background: #f8f9fa; color: #666; font-size: 0.9em; text-transform: uppercase; }
        .status-done { color: green; font-weight: bold; }
        .status-pending { color: orange; font-weight: bold; }
        .maint-thumb { height: 40px; width: 40px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }
        .maint-form { display: none; grid-template-columns: 130px 1fr 1.5fr 100px 160px 80px; gap: 10px; background: #f1f3f5; padding: 15px; border-radius: 8px; align-items: center; margin-bottom: 20px; }

        #loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 768px) { 
            .view-container { flex-direction: column-reverse; } 
            #sidebar, #map { width: 100%; height: 50%; } 
            .manifest-grid { grid-template-columns: 1fr; } 
            .maint-form { grid-template-columns: 1fr; }
            .nav-left { overflow-x: scroll; }
        }
    </style>
</head>
<body>

    <nav>
        <div class="nav-left">
            <h1>s/v Ardenna</h1>
            <div class="tab active" onclick="switchTab('logbook')">Logbook</div>
            <div class="tab" onclick="switchTab('specs')">Vessel Specs</div>
            <div class="tab" onclick="switchTab('crew')">Crew & Story</div>
        </div>
        <div class="admin-lock" onclick="promptAdmin()">ðŸ”’</div>
    </nav>

    <div id="loading"><div class="spinner"></div><span id="loading-text">Syncing with GitHub...</span></div>

    <input type="file" id="quill-image-upload" accept="image/*" style="display:none">

    <div id="view-logbook" class="view-container active">
        <div id="sidebar">
            <div class="sidebar-header" id="log-header">
                <button class="primary admin-only" onclick="toggleForm('entry-form')" style="display:none;">+ Add Log Entry</button>
            </div>

            <div class="filter-bar">
                <select id="log-filter" class="filter-select" onchange="renderLog()">
                    <option value="all">Show All Time</option>
                    <option value="90">Last 90 Days</option>
                </select>
            </div>
            
            <div id="entry-form">
                <h3 id="form-title" style="margin-top:0">New Entry</h3>
                <input type="text" id="title" placeholder="Trip Title" required>
                <input type="date" id="date" required>
                <input type="number" id="miles" placeholder="Distance (nm)" step="0.1" min="0">
                <textarea id="narrative" rows="3" placeholder="Notes..." required></textarea>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="startCoord" placeholder="Click Map (Start)" readonly>
                    <input type="text" id="endCoord" placeholder="Click Map (End)" readonly>
                </div>
                <small>Photo (Optional)</small>
                <input type="file" id="photoInput" accept="image/*">
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="primary" style="background: #28a745;" onclick="saveEntryToGitHub()">Save Entry</button>
                    <button style="background:#6c757d; color:white; border:none; padding:10px; border-radius:4px; cursor:pointer;" onclick="toggleForm('entry-form')">Cancel</button>
                </div>
            </div>
            <div id="entries-container"></div>
        </div>
        
        <div id="map">
            <button class="map-reset-btn" onclick="resetMap()">Reset View</button>
        </div>
    </div>

    <div id="view-specs" class="view-container">
        <div class="scroll-container">
            <div class="manifest-grid">
                <div class="card">
                    <h2>The Vessel</h2>
                    <div id="editor-boat"></div>
                </div>
                <div class="card">
                    <h2>Technical Specs</h2>
                    <div id="editor-tech"></div>
                </div>
            </div>
            <div style="text-align: center; margin-bottom: 30px;">
                <button id="btn-save-specs" class="primary admin-only" style="width: 200px; display:none;" onclick="saveManifestToGitHub()">Save Specs Changes</button>
            </div>

            <div class="maint-section">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2 style="margin:0">Maintenance Log</h2>
                    <button class="primary admin-only" onclick="toggleForm('maint-form')" style="width:auto; display:none;">+ Add Record</button>
                </div>
                
                <div id="maint-form" class="maint-form">
                    <input type="date" id="m-date">
                    <input type="text" id="m-item" placeholder="Item">
                    <input type="text" id="m-notes" placeholder="Notes">
                    <select id="m-status">
                        <option value="Done">Done</option>
                        <option value="Pending">Pending</option>
                    </select>
                    <input type="file" id="m-photo" accept="image/*" style="font-size: 0.8em">
                    <button class="primary" onclick="saveMaintenanceToGitHub()">Save</button>
                </div>

                <table id="maint-table">
                    <thead>
                        <tr>
                            <th width="15%">Date</th>
                            <th width="20%">Item</th>
                            <th>Notes</th>
                            <th width="10%">Status</th>
                            <th width="10%">Photo</th>
                            <th width="5%"></th>
                        </tr>
                    </thead>
                    <tbody id="maint-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="view-crew" class="view-container">
        <div class="scroll-container">
            <div class="card" style="min-height: 500px;">
                <h2>Crew & Vessel Story</h2>
                <div id="editor-crew"></div>
                <div style="margin-top:15px; text-align:right;">
                    <button id="btn-save-crew" class="primary admin-only" style="width: 150px; display:none;" onclick="saveManifestToGitHub()">Save Story</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    
    <script>
        // ==========================================
        // 1. CONFIGURATION (EDIT THIS!)
        // ==========================================
        const CONFIG = {
            owner: 'dbaverill', // e.g. 'johndoe'
            repo: 'Ardenna',    // e.g. 'logbook'
            branch: 'main'
        };

        // GLOBAL STATE
        let GH_TOKEN = localStorage.getItem('gh_token');
        let trips = [];
        let maintLog = [];
        let manifest = { boat: "", tech: "", crew: "" };
        let activeLayerGroup = L.layerGroup(); 
        let pickingStart = true;
        let editingTrip = null; 
        let activeQuill = null; // To track which editor triggered image upload
        
        // INIT MAP
        const map = L.map('map').setView([41.49, -71.31], 6);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);
        activeLayerGroup.addTo(map);

        // INIT QUILL with IMAGE HANDLER
        function imageHandler() {
            activeQuill = this.quill;
            document.getElementById('quill-image-upload').click();
        }

        const toolbarOptions = {
            container: [
                ['bold', 'italic', 'underline'], 
                [{'list': 'ordered'}, {'list': 'bullet'}], 
                ['image'], // Image button added here
                ['clean']
            ],
            handlers: {
                image: imageHandler
            }
        };

        const quillBoat = new Quill('#
