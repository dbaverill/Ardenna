<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>s/v Ardenna Log</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; background: #f4f4f9; }
        
        /* Navigation */
        nav { background: #2c3e50; padding: 0 10px; display: flex; align-items: center; height: 50px; flex-shrink: 0; justify-content: space-between; }
        .nav-left { display: flex; align-items: center; overflow-x: auto; }
        nav h1 { color: white; margin: 0 15px 0 0; font-size: 1.1rem; font-style: italic; white-space: nowrap; }
        .tab { color: #aaa; padding: 15px 15px; cursor: pointer; text-transform: uppercase; font-size: 0.8rem; font-weight: bold; letter-spacing: 1px; white-space: nowrap; }
        .tab:hover { color: white; }
        .tab.active { color: white; border-bottom: 3px solid #3498db; background: rgba(255,255,255,0.05); }
        
        /* Admin Lock */
        .admin-lock { cursor: pointer; opacity: 0.3; font-size: 1.2rem; margin-left: 10px; }
        .admin-lock:hover { opacity: 1; }
        .admin-active { opacity: 1; filter: drop-shadow(0 0 5px #00ff00); }

        /* Main Views */
        .view-container { display: none; height: calc(100vh - 50px); width: 100%; }
        .view-container.active { display: flex; }
        
        /* Sidebar & Map */
        #sidebar { width: 400px; display: flex; flex-direction: column; background: #f8f9fa; border-right: 1px solid #ddd; z-index: 2; overflow: hidden; }
        #map { flex-grow: 1; height: 100%; z-index: 1; position: relative; }
        .map-reset-btn { position: absolute; top: 10px; right: 10px; z-index: 1000; background: white; padding: 8px 12px; border-radius: 4px; border: 2px solid rgba(0,0,0,0.2); cursor: pointer; font-weight: bold; font-size: 0.9em; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        /* Common Elements */
        .sidebar-header { padding: 20px; background: white; border-bottom: 1px solid #eee; display: none; }
        button.primary { background: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; width: 100%; font-size: 1rem; }
        input, textarea, select { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        /* FILTER BAR */
        .filter-bar { padding: 10px 15px; background: #fff; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
        .filter-select { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; background: #f9f9f9; font-size: 0.9rem; margin: 0; }

        /* Log Entries */
        #entries-container { flex-grow: 1; overflow-y: auto; padding: 0; }
        
        /* Collapsible Month Headers */
        .month-header { 
            padding: 12px 15px; 
            background: #e9ecef; 
            font-weight: bold; 
            border-bottom: 1px solid #ddd; 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            color: #2c3e50;
            user-select: none;
        }
        .month-header:hover { background: #dee2e6; }
        .month-header .toggle-icon { font-size: 0.8em; color: #666; }
        
        .log-entry { background: white; padding: 15px; border-radius: 8px; margin: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; border: 1px solid #eee; position: relative; transition: border-color 0.2s; }
        .log-entry:hover { border-color: #3498db; }
        .log-entry.active-trip { border-left: 5px solid #3498db; background: #fafdff; }
        .log-img { width: 100%; height: auto; border-radius: 4px; margin-top: 10px; background: #eee; display: block; }
        .log-stats { font-size: 0.85em; color: #555; background: #f1f3f5; padding: 5px 10px; border-radius: 4px; display: inline-block; margin-top: 5px; font-weight: 500; }
        #entry-form { display: none; padding: 15px; background: #eef2f5; border-bottom: 1px solid #ddd; }
        
        /* Buttons */
        .action-btn { position: absolute; top: 10px; cursor: pointer; font-size: 1.2rem; line-height: 1; padding: 5px; z-index: 10; display: none; font-weight: bold; }
        .delete-btn { right: 10px; color: #ff4444; }
        .edit-btn { right: 40px; color: #aaa; }

        /* General Layouts (Specs & Crew) */
        .scroll-container { flex-direction: column; overflow-y: auto; padding: 40px; box-sizing: border-box; max-width: 1200px; margin: 0 auto; width: 100%; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #eee; display: flex; flex-direction: column; margin-bottom: 20px; }
        .card h2 { margin-top: 0; font-size: 1.2rem; color: #2c3e50; border-bottom: 2px solid #f1f1f1; padding-bottom: 10px; }
        
        /* Specs Grid */
        .manifest-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 40px; }
        
        /* Crew & Gallery Grid */
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 20px; }
        .gallery-item { position: relative; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); aspect-ratio: 1 / 1; }
        .gallery-img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
        .gallery-item:hover .gallery-img { transform: scale(1.05); }
        .gallery-del { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; border-radius: 50%; width: 25px; height: 25px; text-align: center; line-height: 25px; cursor: pointer; display: none; }

        /* Quill */
        .ql-container { font-family: -apple-system, system-ui, sans-serif; font-size: 1rem; height: 250px; }
        .ql-toolbar { border-radius: 4px 4px 0 0; }
        .ql-container { border-radius: 0 0 4px 4px; background: #fafafa; }

        /* Maintenance Table */
        .maint-section { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        th { background: #f8f9fa; color: #666; font-size: 0.9em; text-transform: uppercase; }
        .status-done { color: green; font-weight: bold; }
        .status-pending { color: orange; font-weight: bold; }
        .maint-thumb { height: 40px; width: 40px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }
        .maint-form { display: none; grid-template-columns: 130px 1fr 1.5fr 100px 160px 80px; gap: 10px; background: #f1f3f5; padding: 15px; border-radius: 8px; align-items: center; margin-bottom: 20px; }

        #loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 768px) { 
            .view-container { flex-direction: column-reverse; } 
            #sidebar, #map { width: 100%; height: 50%; } 
            .manifest-grid { grid-template-columns: 1fr; } 
            .maint-form { grid-template-columns: 1fr; }
            .nav-left { overflow-x: scroll; }
        }
    </style>
</head>
<body>

    <nav>
        <div class="nav-left">
            <h1>s/v Ardenna</h1>
            <div class="tab active" onclick="switchTab('logbook')">Logbook</div>
            <div class="tab" onclick="switchTab('specs')">Vessel Specs</div>
            <div class="tab" onclick="switchTab('crew')">Crew & Gallery</div>
        </div>
        <div class="admin-lock" onclick="promptAdmin()">ðŸ”’</div>
    </nav>

    <div id="loading"><div class="spinner"></div><span id="loading-text">Syncing with GitHub...</span></div>

    <div id="view-logbook" class="view-container active">
        <div id="sidebar">
            <div class="sidebar-header" id="log-header">
                <button class="primary admin-only" onclick="toggleForm('entry-form')" style="display:none;">+ Add Log Entry</button>
            </div>

            <div class="filter-bar">
                <select id="log-filter" class="filter-select" onchange="renderLog()">
                    <option value="all">Show All Time</option>
                    <option value="90">Last 90 Days</option>
                    </select>
            </div>
            
            <div id="entry-form">
                <h3 id="form-title" style="margin-top:0">New Entry</h3>
                <input type="text" id="title" placeholder="Trip Title" required>
                <input type="date" id="date" required>
                <input type="number" id="miles" placeholder="Distance (nm)" step="0.1" min="0">
                <textarea id="narrative" rows="3" placeholder="Notes..." required></textarea>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="startCoord" placeholder="Click Map (Start)" readonly>
                    <input type="text" id="endCoord" placeholder="Click Map (End)" readonly>
                </div>
                <small>Photo (Optional)</small>
                <input type="file" id="photoInput" accept="image/*">
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="primary" style="background: #28a745;" onclick="saveEntryToGitHub()">Save Entry</button>
                    <button style="background:#6c757d; color:white; border:none; padding:10px; border-radius:4px; cursor:pointer;" onclick="toggleForm('entry-form')">Cancel</button>
                </div>
            </div>
            <div id="entries-container"></div>
        </div>
        
        <div id="map">
            <button class="map-reset-btn" onclick="resetMap()">Reset View</button>
        </div>
    </div>

    <div id="view-specs" class="view-container">
        <div class="scroll-container">
            <div class="manifest-grid">
                <div class="card">
                    <h2>The Vessel</h2>
                    <div id="editor-boat"></div>
                </div>
                <div class="card">
                    <h2>Technical Specs</h2>
                    <div id="editor-tech"></div>
                </div>
            </div>
            <div style="text-align: center; margin-bottom: 30px;">
                <button id="btn-save-specs" class="primary admin-only" style="width: 200px; display:none;" onclick="saveManifestToGitHub()">Save Specs Changes</button>
            </div>

            <div class="maint-section">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2 style="margin:0">Maintenance Log</h2>
                    <button class="primary admin-only" onclick="toggleForm('maint-form')" style="width:auto; display:none;">+ Add Record</button>
                </div>
                
                <div id="maint-form" class="maint-form">
                    <input type="date" id="m-date">
                    <input type="text" id="m-item" placeholder="Item">
                    <input type="text" id="m-notes" placeholder="Notes">
                    <select id="m-status">
                        <option value="Done">Done</option>
                        <option value="Pending">Pending</option>
                    </select>
                    <input type="file" id="m-photo" accept="image/*" style="font-size: 0.8em">
                    <button class="primary" onclick="saveMaintenanceToGitHub()">Save</button>
                </div>

                <table id="maint-table">
                    <thead>
                        <tr>
                            <th width="15%">Date</th>
                            <th width="20%">Item</th>
                            <th>Notes</th>
                            <th width="10%">Status</th>
                            <th width="10%">Photo</th>
                            <th width="5%"></th>
                        </tr>
                    </thead>
                    <tbody id="maint-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="view-crew" class="view-container">
        <div class="scroll-container">
            <div class="card">
                <h2>Crew & Vessel Story</h2>
                <div id="editor-crew"></div>
                <div style="margin-top:15px; text-align:right;">
                    <button id="btn-save-crew" class="primary admin-only" style="width: 150px; display:none;" onclick="saveManifestToGitHub()">Save Text</button>
                </div>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 2px solid #f1f1f1; padding-bottom:10px;">
                    <h2 style="margin:0; border:none; padding:0;">Photo Gallery</h2>
                    <button class="primary admin-only" style="width:auto; display:none;" onclick="document.getElementById('gallery-upload').click()">+ Upload Photo</button>
                    <input type="file" id="gallery-upload" accept="image/*" style="display:none" onchange="uploadGalleryPhoto(this)">
                </div>
                
                <div id="gallery-container" class="gallery-grid">
                    </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    
    <script>
        // ==========================================
        // 1. CONFIGURATION (EDIT THIS!)
        // ==========================================
        const CONFIG = {
            owner: 'YOUR_GITHUB_USERNAME', // e.g. 'johndoe'
            repo: 'sailingardenna.com',    // e.g. 'logbook'
            branch: 'main'
        };

        // GLOBAL STATE
        let GH_TOKEN = localStorage.getItem('gh_token');
        let trips = [];
        let maintLog = [];
        let manifest = { boat: "", tech: "", crew: "", gallery: [] };
        let activeLayerGroup = L.layerGroup(); 
        let pickingStart = true;
        let editingTrip = null; 
        
        // INIT MAP
        const map = L.map('map').setView([41.49, -71.31], 6);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);
        activeLayerGroup.addTo(map);

        // INIT QUILL
        const quillOptions = {
            theme: 'snow',
            modules: { toolbar: [['bold', 'italic', 'underline'], [{'list': 'ordered'}, {'list': 'bullet'}], ['clean']] }
        };
        const quillBoat = new Quill('#editor-boat', quillOptions);
        const quillTech = new Quill('#editor-tech', quillOptions);
        const quillCrew = new Quill('#editor-crew', quillOptions);

        // ==========================================
        // 2. GITHUB API HELPERS
        // ==========================================
        async function ghGet(path) {
            const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${path}?ref=${CONFIG.branch}&t=${Date.now()}`;
            const headers = GH_TOKEN ? { "Authorization": `token ${GH_TOKEN}` } : {};
            const res = await fetch(url, { headers, cache: "no-store" });
            if (!res.ok) return null;
            const data = await res.json();
            return {
                sha: data.sha,
                content: JSON.parse(new TextDecoder().decode(Uint8Array.from(atob(data.content), c => c.charCodeAt(0))))
            };
        }

        async function ghPut(path, content, message, sha = null) {
            if (!GH_TOKEN) return alert("Admin Token Missing");
            showLoading(true);
            const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${path}`;
            const body = {
                message: message,
                content: btoa(String.fromCharCode(...new Uint8Array(new TextEncoder().encode(content)))),
                branch: CONFIG.branch
            };
            if (sha) body.sha = sha;

            const res = await fetch(url, {
                method: 'PUT',
                headers: { "Authorization": `token ${GH_TOKEN}`, "Content-Type": "application/json" },
                body: JSON.stringify(body)
            });
            showLoading(false);
            return res.ok;
        }

        async function ghUploadImage(file) {
            if (!GH_TOKEN) return null;
            showLoading(true);
            const filename = `images/${Date.now()}-${file.name.replace(/\s/g, '_')}`;
            const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${filename}`;
            const base64 = await new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(file);
            });
            const res = await fetch(url, {
                method: 'PUT',
                headers: { "Authorization": `token ${GH_TOKEN}`, "Content-Type": "application/json" },
                body: JSON.stringify({ message: `Upload ${filename}`, content: base64, branch: CONFIG.branch })
            });
            showLoading(false);
            if(res.ok) return filename; 
            return null;
        }

        function getImgUrl(path) {
            if (!path) return '';
            if (path.startsWith('http')) return path;
            return `https://raw.githubusercontent.com/${CONFIG.owner}/${CONFIG.repo}/${CONFIG.branch}/${path}`;
        }

        // ==========================================
        // 3. APP LOGIC
        // ==========================================
        async function loadData() {
            showLoading(true);
            const tData = await ghGet('trips.json');
            trips = tData ? tData.content : [];
            const mData = await ghGet('manifest.json');
            manifest = mData ? mData.content : { boat: "", tech: "", crew: "", gallery: [] };
            if(!manifest.gallery) manifest.gallery = []; 
            const mainData = await ghGet('maintenance.json');
            maintLog = mainData ? mainData.content : [];

            populateFilter(); // New: Populate Years
            renderLog();
            renderManifest();
            renderMaint();
            renderGallery();
            checkAdmin();
            showLoading(false);
        }

        function populateFilter() {
            const select = document.getElementById('log-filter');
            // Keep first two options (All, 90 days)
            while (select.options.length > 2) select.remove(2);
            
            // Get unique years
            const years = [...new Set(trips.map(t => t.date.split('-')[0]))].sort().reverse();
            years.forEach(y => {
                const opt = document.createElement('option');
                opt.value = y;
                opt.innerText = y;
                select.appendChild(opt);
            });
        }

        // --- Logbook ---
        function renderLog() {
            const container = document.getElementById('entries-container');
            container.innerHTML = '';
            map.eachLayer(l => { if (!!l.toGeoJSON && l !== activeLayerGroup) map.removeLayer(l); });
            activeLayerGroup.clearLayers();

            // 1. Calculate Odometer (Chronological) on FULL DATASET
            trips.sort((a, b) => new Date(a.date) - new Date(b.date));
            let runningTotal = 0;
            trips.forEach(t => {
                const legMiles = parseFloat(t.miles) || 0;
                runningTotal += legMiles;
                t.calculatedTotal = runningTotal;
            });

            // 2. Filter
            const filterVal = document.getElementById('log-filter').value;
            const now = new Date();
            const filteredTrips = trips.filter(t => {
                const d = new Date(t.date);
                if(filterVal === 'all') return true;
                if(filterVal === '90') return (now - d) / (1000 * 60 * 60 * 24) <= 90;
                return d.getFullYear().toString() === filterVal;
            });

            // 3. Render Map Ghost Trail for FILTERED trips
            const allCoords = [];
            filteredTrips.forEach(t => {
                L.circleMarker(t.startCoords, {radius: 3, color: '#888', fillColor: '#ccc', fillOpacity:1, weight:1}).addTo(map);
                L.polyline([t.startCoords, t.endCoords], {color: '#999', weight: 2, opacity: 0.4, dashArray: '5,5'}).addTo(map);
                allCoords.push(t.startCoords, t.endCoords);
            });
            if(allCoords.length > 0) map.fitBounds(allCoords);

            // 4. Sort for List (Newest First)
            const displayTrips = [...filteredTrips].sort((a, b) => new Date(b.date) - new Date(a.date));

            // 5. Group
            const groups = {};
            displayTrips.forEach(t => {
                const k = new Date(t.date).toLocaleString('default', { month: 'long', year: 'numeric' });
                if(!groups[k]) groups[k] = [];
                groups[k].push(t);
            });

            Object.keys(groups).forEach(month => {
                const header = document.createElement('div');
                header.className = 'month-header';
                header.innerHTML = `<span>${month}</span> <span class="toggle-icon">â–¶</span>`; // Default Closed Icon
                
                const groupDiv = document.createElement('div');
                groupDiv.style.display = 'none'; // Default Closed

                header.onclick = () => {
                    const isOpen = groupDiv.style.display !== 'none';
                    groupDiv.style.display = isOpen ? 'none' : 'block';
                    header.querySelector('.toggle-icon').innerText = isOpen ? 'â–¶' : 'â–¼';
                };

                container.appendChild(header);
                container.appendChild(groupDiv);

                groups[month].forEach(trip => {
                    const el = document.createElement('div');
                    el.className = 'log-entry';
                    el.id = `entry-${trip.date}-${trip.title.replace(/\s/g,'')}`;
                    const safeTitle = trip.title.replace(/'/g, "\\'");
                    const milesDisplay = trip.miles ? `<div class="log-stats">Dist: ${trip.miles} nm | Total: ${trip.calculatedTotal.toFixed(1)} nm</div>` : '';

                    el.innerHTML = `
                        <span class="action-btn delete-btn admin-only" onclick="event.stopPropagation(); deleteTrip('${trip.date}', '${safeTitle}')">âœ•</span>
                        <span class="action-btn edit-btn admin-only" onclick="event.stopPropagation(); editTrip('${trip.date}', '${safeTitle}')">âœŽ</span>
                        <div style="font-size:0.8em; color:#888; font-weight:bold">${trip.date}</div>
                        <h3 style="margin:5px 0">${trip.title}</h3>
                        ${milesDisplay}
                        <p>${trip.text}</p>
                        ${trip.image ? `<img src="${getImgUrl(trip.image)}" class="log-img">` : ''}
                    `;
                    el.onclick = () => highlightTripOnMap(trip, el.id);
                    groupDiv.appendChild(el); 
                });
            });
        }

        function highlightTripOnMap(trip, elemId) {
            activeLayerGroup.clearLayers();
            document.querySelectorAll('.log-entry').forEach(e => e.classList.remove('active-trip'));
            const el = document.getElementById(elemId);
            if(el) el.classList.add('active-trip');
            L.marker(trip.startCoords).addTo(activeLayerGroup).bindPopup(`<b>${trip.title}</b><br>Start`).openPopup();
            L.marker(trip.endCoords).addTo(activeLayerGroup).bindPopup('End');
            L.polyline([trip.startCoords, trip.endCoords], {color: 'navy', weight: 4}).addTo(activeLayerGroup);
            map.flyToBounds([trip.startCoords, trip.endCoords], {padding: [50,50], maxZoom: 9});
        }

        function resetMap() {
            activeLayerGroup.clearLayers();
            document.querySelectorAll('.log-entry').forEach(e => e.classList.remove('active-trip'));
            // Refilter coords based on current selection
            renderLog(); // This effectively resets view
        }

        // --- Manifest & Gallery ---
        function renderManifest() {
            quillBoat.root.innerHTML = manifest.boat || "Enter details...";
            quillTech.root.innerHTML = manifest.tech || "Enter details...";
            quillCrew.root.innerHTML = manifest.crew || "Enter details...";
        }

        function renderGallery() {
            const container = document.getElementById('gallery-container');
            container.innerHTML = '';
            if (manifest.gallery && manifest.gallery.length > 0) {
                 manifest.gallery.forEach((img, idx) => {
                    const div = document.createElement('div');
                    div.className = 'gallery-item';
                    div.innerHTML = `
                        <img src="${getImgUrl(img.url)}" class="gallery-img" onclick="window.open('${getImgUrl(img.url)}')">
                        <div class="gallery-del admin-only" onclick="deleteGalleryPhoto(${idx})">âœ•</div>
                    `;
                    container.prepend(div); 
                 });
            } else {
                container.innerHTML = '<p style="grid-column: 1/-1; text-align:center; color:#aaa; padding:20px;">No photos yet.</p>';
            }
        }

        async function uploadGalleryPhoto(input) {
            if (!input.files[0]) return;
            const path = await ghUploadImage(input.files[0]);
            if (!path) return alert("Upload failed");

            if(!manifest.gallery) manifest.gallery = [];
            manifest.gallery.push({ url: path, date: new Date().toISOString() });

            const current = await ghGet('manifest.json');
            const success = await ghPut('manifest.json', JSON.stringify(manifest, null, 2), "Add Gallery Photo", current ? current.sha : null);
            
            if (success) {
                alert("Photo uploaded!");
                renderGallery();
                checkAdmin();
            }
            input.value = ''; 
        }

        async function deleteGalleryPhoto(index) {
            if(!confirm("Delete this photo?")) return;
            manifest.gallery.splice(index, 1);
            const current = await ghGet('manifest.json');
            const success = await ghPut('manifest.json', JSON.stringify(manifest, null, 2), "Delete Gallery Photo", current ? current.sha : null);
            if (success) {
                alert("Deleted.");
                renderGallery();
                checkAdmin();
            }
        }

        function renderMaint() {
            const tbody = document.getElementById('maint-body');
            tbody.innerHTML = '';
            maintLog.sort((a, b) => new Date(b.date) - new Date(a.date));
            maintLog.forEach(item => {
                const tr = document.createElement('tr');
                const safeItem = item.item.replace(/'/g, "\\'");
                tr.innerHTML = `
                    <td>${item.date}</td>
                    <td><strong>${item.item}</strong></td>
                    <td>${item.notes}</td>
                    <td class="${item.status === 'Done' ? 'status-done' : 'status-pending'}">${item.status}</td>
                    <td>${item.image ? `<a href="${getImgUrl(item.image)}" target="_blank"><img src="${getImgUrl(item.image)}" class="maint-thumb"></a>` : ''}</td>
                    <td><span class="action-btn delete-btn admin-only" style="position:static; display:none;" onclick="deleteMaint('${item.date}', '${safeItem}')">âœ•</span></td>
                `;
                tbody.appendChild(tr);
            });
            checkAdmin();
        }

        // ==========================================
        // 4. ADMIN ACTIONS
        // ==========================================
        function promptAdmin() {
            if (GH_TOKEN) {
                if(confirm("Logout?")) {
                    localStorage.removeItem('gh_token');
                    GH_TOKEN = null;
                    checkAdmin();
                    alert("Logged out.");
                }
                return;
            }
            const token = prompt("Enter GitHub Personal Access Token:");
            if (token && token.startsWith('ghp_')) {
                GH_TOKEN = token;
                localStorage.setItem('gh_token', token); 
                checkAdmin();
                alert("Admin Mode Enabled");
            } else {
                alert("Invalid Token");
            }
        }

        function checkAdmin() {
            const isAdmin = !!GH_TOKEN;
            document.querySelector('.admin-lock').classList.toggle('admin-active', isAdmin);
            const logHeader = document.getElementById('log-header');
            if (logHeader) logHeader.style.display = isAdmin ? 'block' : 'none';
            
            document.querySelectorAll('.admin-only').forEach(el => {
                if(el.tagName === 'SPAN' || el.className.includes('gallery-del')) el.style.display = isAdmin ? 'block' : 'none';
                else el.style.display = isAdmin ? 'inline-block' : 'none';
            });

            quillBoat.enable(isAdmin);
            quillTech.enable(isAdmin);
            quillCrew.enable(isAdmin);
        }

        // --- EDIT/DELETE LOGIC ---
        function editTrip(date, title) {
            const trip = trips.find(t => t.date === date && t.title === title);
            if (!trip) return;
            editingTrip = trip; 
            document.getElementById('title').value = trip.title;
            document.getElementById('date').value = trip.date;
            document.getElementById('miles').value = trip.miles || '';
            document.getElementById('narrative').value = trip.text;
            
            const startStr = `${trip.startCoords[0].toFixed(4)}, ${trip.startCoords[1].toFixed(4)}`;
            const endStr = `${trip.endCoords[0].toFixed(4)}, ${trip.endCoords[1].toFixed(4)}`;
            
            const startInput = document.getElementById('startCoord');
            startInput.value = startStr;
            startInput.dataset.raw = JSON.stringify(trip.startCoords);
            
            const endInput = document.getElementById('endCoord');
            endInput.value = endStr;
            endInput.dataset.raw = JSON.stringify(trip.endCoords);

            document.getElementById('form-title').innerText = "Edit Entry";
            document.getElementById('entry-form').style.display = 'block';
            window.scrollTo(0,0);
        }

        async function saveEntryToGitHub() {
            const title = document.getElementById('title').value;
            const date = document.getElementById('date').value;
            const text = document.getElementById('narrative').value;
            const miles = document.getElementById('miles').value;
            const startRaw = document.getElementById('startCoord').dataset.raw;
            const endRaw = document.getElementById('endCoord').dataset.raw;
            const fileInput = document.getElementById('photoInput');

            if (!title || !date || !startRaw) return alert("Missing Fields");

            let imagePath = null;
            if (editingTrip && !fileInput.files[0]) {
                imagePath = editingTrip.image;
            } 
            else if (fileInput.files[0]) {
                imagePath = await ghUploadImage(fileInput.files[0]);
                if (!imagePath) return alert("Image Upload Failed");
            }

            const current = await ghGet('trips.json');
            let updatedList = current ? current.content : [];
            if (editingTrip) {
                updatedList = updatedList.filter(t => !(t.date === editingTrip.date && t.title === editingTrip.title));
            }
            const newEntry = { 
                title, date, text, miles, 
                image: imagePath, 
                startCoords: JSON.parse(startRaw), 
                endCoords: JSON.parse(endRaw) 
            };
            updatedList.push(newEntry);
            const msg = editingTrip ? `Update trip: ${title}` : `Add trip: ${title}`;
            const success = await ghPut('trips.json', JSON.stringify(updatedList, null, 2), msg, current ? current.sha : null);
            if (success) { 
                alert("Saved!"); 
                document.getElementById('entry-form').style.display = 'none';
                document.getElementById('title').value = '';
                document.getElementById('narrative').value = '';
                document.getElementById('miles').value = '';
                document.getElementById('form-title').innerText = "New Entry";
                editingTrip = null; 
                loadData(); 
            }
        }

        async function deleteTrip(date, title) {
            if(!confirm("Delete this entry?")) return;
            const current = await ghGet('trips.json');
            if(!current) return alert("Sync Error");
            const updatedList = current.content.filter(t => !(t.date === date && t.title === title));
            const success = await ghPut('trips.json', JSON.stringify(updatedList, null, 2), `Delete: ${title}`, current.sha);
            if(success) { alert("Deleted."); loadData(); }
        }

        async function deleteMaint(date, item) {
            if(!confirm("Delete this record?")) return;
            const current = await ghGet('maintenance.json');
            if(!current) return alert("Sync Error");
            const updatedList = current.content.filter(m => !(m.date === date && m.item === item));
            const success = await ghPut('maintenance.json', JSON.stringify(updatedList, null, 2), `Delete Maint: ${item}`, current.sha);
            if(success) { alert("Deleted."); loadData(); }
        }

        async function saveMaintenanceToGitHub() {
            const date = document.getElementById('m-date').value;
            const item = document.getElementById('m-item').value;
            const notes = document.getElementById('m-notes').value;
            const status = document.getElementById('m-status').value;
            const fileInput = document.getElementById('m-photo');
            if (!date || !item) return alert("Missing Fields");

            let imagePath = null;
            if (fileInput.files[0]) {
                imagePath = await ghUploadImage(fileInput.files[0]);
                if (!imagePath) return alert("Image Upload Failed");
            }
            const current = await ghGet('maintenance.json');
            const updatedList = current ? [...current.content, { date, item, notes, status, image: imagePath }] 
                                        : [{ date, item, notes, status, image: imagePath }];
            const success = await ghPut('maintenance.json', JSON.stringify(updatedList, null, 2), `Maint: ${item}`, current ? current.sha : null);
            if (success) { alert("Saved!"); toggleForm('maint-form'); loadData(); }
        }

        async function saveManifestToGitHub() {
            // Update manifest object with values from editors
            manifest.boat = quillBoat.root.innerHTML;
            manifest.tech = quillTech.root.innerHTML;
            manifest.crew = quillCrew.root.innerHTML;
            
            const current = await ghGet('manifest.json');
            const success = await ghPut('manifest.json', JSON.stringify(manifest, null, 2), "Update Manifest", current ? current.sha : null);
            if (success) alert("Manifest Updated!");
        }

        // ==========================================
        // 5. UI HANDLERS
        // ==========================================
        function toggleForm(id) {
            const f = document.getElementById(id);
            if (id === 'entry-form' && f.style.display === 'none') {
                 if (!editingTrip) {
                    document.getElementById('title').value = '';
                    document.getElementById('narrative').value = '';
                    document.getElementById('miles').value = '';
                    document.getElementById('date').value = new Date().toISOString().split('T')[0];
                    document.getElementById('form-title').innerText = "New Entry";
                 }
            }
            f.style.display = f.style.display === 'grid' || f.style.display === 'block' ? 'none' : (id === 'maint-form' ? 'grid' : 'block');
            if (id === 'entry-form' && f.style.display === 'none') editingTrip = null;
            map.invalidateSize();
        }

        function switchTab(tab) {
            document.querySelectorAll('.view-container').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
            
            if(tab === 'logbook') {
                document.getElementById('view-logbook').classList.add('active');
                document.querySelectorAll('.tab')[0].classList.add('active');
                map.invalidateSize();
            } else if (tab === 'specs') {
                document.getElementById('view-specs').classList.add('active');
                document.querySelectorAll('.tab')[1].classList.add('active');
            } else {
                document.getElementById('view-crew').classList.add('active');
                document.querySelectorAll('.tab')[2].classList.add('active');
            }
        }

        function showLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }

        map.on('click', function(e) {
            if (document.getElementById('entry-form').style.display === 'block') {
                const c = `${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
                const raw = JSON.stringify([e.latlng.lat, e.latlng.lng]);
                if (pickingStart) {
                    document.getElementById('startCoord').value = c;
                    document.getElementById('startCoord').dataset.raw = raw;
                    L.popup().setLatLng(e.latlng).setContent("Start Set").openOn(map);
                    pickingStart = false;
                } else {
                    document.getElementById('endCoord').value = c;
                    document.getElementById('endCoord').dataset.raw = raw;
                    L.popup().setLatLng(e.latlng).setContent("End Set").openOn(map);
                    pickingStart = true;
                }
            }
        });

        // INIT
        loadData();
    </script>
</body>
</html>
